variables:
  GIT_STRATEGY: clone
  GIT_SUBMODULE_STRATEGY: none
  NIX_CI_IMAGE: "$CI_REGISTRY/$CI_REGISTRY_USER/isax-tools-integration-env:latest"
  NIX_BUNDLE_IMAGE: "$CI_REGISTRY/$CI_REGISTRY_USER/isax-tools-integration-image-builder:latest"
  OR_TOOLS_VER: "9.11"

stages:
    - deps
    - build

build-circt:
    stage: deps
    image: $NIX_CI_IMAGE
    tags:
        - Ultra
    rules:
        - if: $CI_MERGE_REQUEST_IID
          changes:
            - circt
            - build_circt.sh
            - nix/circt_export_verilog.patch
            - build_deps.sh
            #- .gitlab-ci.yml
        - if: $CI_COMMIT_TAG
          changes:
            - circt
            - build_circt.sh
            - build_deps.sh
            #- .gitlab-ci.yml
        - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
          changes:
            - circt
            - build_circt.sh
            - build_deps.sh
            #- .gitlab-ci.yml
    script:
        - ./build_deps.sh
        - ./build_circt.sh
    cache:
        key:
            files:
                - circt
        paths:
            - circt
        policy: push

build-shortnail:
    stage: build
    image: $NIX_CI_IMAGE
    tags:
        - Ultra
    rules:
        - if: $CI_MERGE_REQUEST_IID
        - if: $CI_COMMIT_TAG
        - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    script:
        # Caching didn't work :-( fall-back: repeat steps from the build-circt step above
        - if [[ ! -d circt/build ]] ; then
            ./build_deps.sh ;
            ./build_circt.sh ;
          fi
        - ./build_shortnail.sh
    cache:
        key:
            files:
                - circt
        paths:
            - circt

bundle-shortnail:
    stage: build
    image: $NIX_BUNDLE_IMAGE
    tags:
        - Ultra
    rules:
        - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    script:
        - git submodule update --init --recursive --depth 1
        - TMPDIR=`pwd` nix bundle --bundler github:DavHau/nix-portable .#
        - cp shortnail/bin/shortnail-opt shortnail-opt
    artifacts:
        when: always
        paths:
            - shortnail-opt
        expire_in: 1 day

clang-format-vs-prev-commit:
    stage: build
    image: $NIX_CI_IMAGE
    tags:
        - Normal
    script:
        # Taken from: https://github.com/llvm/circt/blob/e66d68089b46fea5d89c73fdbc15e8e48c63ffce/.github/workflows/buildAndTest.yml
        - |
          git checkout . # Try to prevent false positive LFS changes
          DIFF_COMMIT_SHA=$(git rev-parse HEAD^)
          git clang-format $DIFF_COMMIT_SHA
          git diff --ignore-submodules > clang-format.patch
          if [ -s clang-format.patch ]; then
            echo "Clang-format found formatting problems in the following files. See diff in the clang-format.patch artifact."
            git diff --ignore-submodules --name-only
            git checkout .
            exit 1
          fi
          echo "Clang-format found no formatting problems"
          exit 0
    artifacts:
        when: on_failure
        paths:
            - clang-format.patch

clang-format-vs-target:
    stage: build
    image: $NIX_CI_IMAGE
    tags:
        - Normal
    variables:
        GIT_DEPTH: 0 # Fetch all available branches
    rules:
        - if: $CI_MERGE_REQUEST_IID
    script:
        # Taken from: https://github.com/llvm/circt/blob/e66d68089b46fea5d89c73fdbc15e8e48c63ffce/.github/workflows/buildAndTest.yml
        - |
          git checkout . # Try to prevent false positive LFS changes
          DIFF_COMMIT_SHA=$(git rev-parse origin/$CI_MERGE_REQUEST_TARGET_BRANCH_NAME)
          git clang-format $DIFF_COMMIT_SHA
          git diff --ignore-submodules > clang-format.patch
          if [ -s clang-format.patch ]; then
            echo "Clang-format found formatting problems in the following files. See diff in the clang-format.patch artifact."
            git diff --ignore-submodules --name-only
            git checkout .
            exit 1
          fi
          echo "Clang-format found no formatting problems"
          exit 0
    artifacts:
        when: on_failure
        paths:
            - clang-format.patch
